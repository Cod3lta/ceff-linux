# 3.5.1.E Serveur Nextcloud
Dans cet exercice, nous allons installer un serveur Nextcloud sur la machine virtuelle Ubuntu Server 22.04, puis y acc√©der depuis la machine virtuelle Ubuntu Desktop.

Cet exercice est tir√© de ce tutoriel : [https://docs.nextcloud.com/server/22/admin_manual/installation/example_ubuntu.html](https://docs.nextcloud.com/server/22/admin_manual/installation/example_ubuntu.html)

> üö® **Cet exercice a pour but de vous entra√Æner √† suivre un tutoriel en ligne, un peu comme on pourrait faire dans un cas r√©el.**  
> Il faudra donc modifier pour adapter des commandes, passer des √©tapes si besoin, etc...  
> Ici, je vais uniquement vous indiquer quoi faire par rapport au tutoriel de base üôÇ  
> **Ouvrez donc le tutoriel dans un nouvel onglet de votre navigateur pour le suivre, en vous basant sur les indications que vous trouverez ici.** 

---

## Nextcloud
Site web : [https://nextcloud.com/](https://nextcloud.com/)

Nextcloud est un logiciel open-source, d√©velopp√© pour la premi√®re fois en 2016, qui permet de g√©rer un service de stockage dans le cloud personnel. Ses fonctionnalit√©s sont comparables √† celles d'autres services tels que Dropbox.

Le logiciel serveur Nextcloud peut √™tre install√© gratuitement sur Linux, et le logiciel client peut √™tre install√© sur des ordinateurs fonctionnant sous Windows, OS X ou Linux. Des applications mobiles sont √©galement disponibles pour Android et iOS.

Logo de NextCloud 
![](https://i.imgur.com/YiAi5B9t.png)

Interface Utilisateur
![](https://i.imgur.com/2t7lZcW.png)


---

Il existe plusieurs fa√ßons d'installer le serveur NextCloud sur un serveur Linux. (avec APT, snapcraft, etc...).  
Nous allons ici utiliser un script PHP fourni par NextCloud pour le mettre en place dans un serveur web que nous allons configurer au pr√©alable.


> üí° Rappel : je vous indique ici comment suivre le tutoriel cit√© plus haut. Pour avoir les commandes √† ex√©cuter, ouvrez le tutoriel dans un nouvel onglet.  


## √âtape 1 - Installer les paquets
Dans cette √©tape, vous allez installer les paquets mentionn√©s au d√©but du tutoriel. Cependant, la version de PHP indiqu√©e n'est pas la derni√®re : 
- Remplacez tous les "7.4" par des "8.1" dans les paquets PHP √† installer.
	- par exemple : au lieu d'installer `php7.4-gd`, vous allez installer `php8.1-gd`. Pareil pour tous les autres paquets PHP.


## √âtape 2 - La base de donn√©es
Nextcloud a besoin d'avoir acc√®s √† une base de donn√©es MySQL pour fonctionner correctement (comme Wordpress !).  
Les commandes **du tutoriel** vont donc vous permettre de :
- Ouvrir une ligne de commande en mode MySQL
- Cr√©er un utilisateur MySQL pour acc√©der √† votre base de donn√©es
	- Nom d'utilisateur : `CP-21XXX` (votre CP)
	- Mot de passe : `Pa$$w0rd`
- Cr√©er une base de donn√©es s'appelant `nextcloud`.
- Donner tous les privil√®ges sur la base nextcloud √† l'utilisateur MySQL que vous avez cr√©√©.
- Appliquer les modifications avec `FLUSH PRIVILEGES`.

> üí° Il peut parfois √™tre indiqu√© un message comme "QUERY OK, 0 LINES UPDATED". C'est normal ! MySQL n'a pas besoin de mettre √† jour une base de donn√©es pour certaines des commandes que vous ex√©cutez ici üôÇ

## √âtape 3 - T√©l√©charger NextCloud
- Dans le tutoriel, cliquez sur le lien de t√©l√©chargement de NextCloud.  
- Dans la section "Download Server", trouvez le bouton de t√©l√©chargement avec le "Web Installer". Copiez l'adresse du lien de ce bouton (l'adresse se termine par "setup-nextcloud.php").
- T√©l√©chargez le fichier "setup-nextcloud.php" en ligne de commande sur votre serveur avec la commande `wget`.
	- Faites-le directement dans votre dossier utilisateur (`/home/cp-21xxx`)
- D√©compressez le fichier zip en ligne de commande

## √âtape 4 - V√©rifier le fichier (optionnel)
Le tutoriel vous propose de v√©rifier le fichier en utilisant les commandes `md5sum` et `sha256sum`. Cette √©tape permet de v√©rifier que le fichier que vous avez t√©l√©charg√© est bel et bien celui que vous fourni Nextcloud, bit par bit.  
Comme le fichier d'installation de NextCloud va vous permettre de cr√©er un drive personnel o√π vous pourriez y mettre des informations sensibles, il est important que ce fichier ne soit pas corrompu / modifi√© par une tierce personne qui pourrait installer un virus sur votre serveur.

## √âtape 5 - Configurer un nouveau site avec Apache
> ‚û°Ô∏è Cette √©tape n'est pas indiqu√©e dans le tutoriel, mais correspond √† ce que nous avons vu dans la configuration d'un serveur web Apache  

L'interface de Nextcloud est accessible en vous connectant √† votre serveur Ubuntu via une interface web. Il faut donc cr√©er un site web avec Apache, exactement comme nous l'avions vu pr√©c√©demment :)

- Commencez par cr√©er un dossier s'appelant `nextcloud` dans le dossier `/var/www`
- Copiez le fichier `/etc/apache2/sites-available/000-default.conf` en un fichier s'appelant `/etc/apache2/sites-available/nextcloud.conf`

Voici une arborescence de votre serveur Linux avec les dossiers / fichiers importants :
```
/etc
	/apache2
		/sites-enabled
		/sites-available
			/000-default.conf
			/nextcloud.conf
			[...]
/var
	/www
		/html
		/nextcloud
		[...]
```

- Dans le fichier `/etc/apache2/sites-available/nextcloud.conf`, modifiez le param√®tres "DocumentRoot" pour que le dossier racine du site soit sur `/var/www/nextcloud/`.
- Ajoutez le code suivant √† l'int√©rieur de la balise `<VirtualHost>`:
```conf
	<Directory /var/www/nextcloud/>
		Require all granted
		AllowOverride All
		Options FollowSymLinks MultiViews

		<IfModule mod_dav.c>
			Dav off
		</IfModule>
	</Directory>
```

> üí° Ce bout de code provient de la [page de documentation d'installation sur Linux](https://docs.nextcloud.com/server/22/admin_manual/installation/source_installation.html#apache-configuration-label). Dans un cas r√©el, √ßa aurait √©t√© √† vous de lire cette page pour y suivre la configuration √† faire.

- Pour √™tre s√ªr de ne pas faire d'erreur, d√©sactivez tous les sites web que vous avez cr√©√© & activez le site `nextcloud`. R√©ferrez-vous √† vos notes personnelles & √† l'exercice que nous avons fait pr√©c√©demment.
- Testez que votre configuration fonctionne bien en accedant √† votre serveur depuis un navigateur. Si le dossier `/var/www/nextcloud` est vide, vous devriez avoir un site retournant une erreur. (et plus la page d'accueil d'Apache).

## √âtape 6 - Installer NextCloud
- Copiez le fichier "setup-nextcloud.php" dans le dossier `/var/www/nextcloud`.
- Acc√©dez √† votre serveur depuis un navigateur, et installez NextCloud en suivant les instructions

Si une erreur s'affiche comme quoi Nextcloud n'a pas les permissions n√©cessaire pour s'installer, il faut donner les permissions sur le dossier `/var/www/nextcloud`.  
Faites `sudo chown www-data /var/www/nextcloud` pour changer le propri√©taire de "root" √† "www-data". Vous devriez voir la mention "www-data" sur la ligne du dossier lorsque vous faites `ls -l` √† la fin.  

> üí° L'utilisateur "www-data" est celui qui est utilis√© par Apache lorsqu'on acc√®de au site via un navigateur ! Quand on acc√®de au fichier "setup-nextcloud.php" de `/var/www/nextcloud`, c'est avec l'utilisateur "www-data".